name: Build and Deploy to Production

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Create deployment archive
        run: |
          # Create a tarball containing dist and package files
          tar -czf dist.tar.gz dist/ package.json package-lock.json
      
      - name: Test SSH connection
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_KEY_PHRASE }}
          port: 22
          timeout: 30s
          debug: true
          script: |
            echo "âœ… SSH connection successful!"
            echo "Server: $(hostname)"
            echo "User: $(whoami)"
            echo "Date: $(date)"
      
      - name: Upload deployment archive to server
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_KEY_PHRASE }}
          port: 22
          timeout: 60s
          command_timeout: 10m
          source: "dist.tar.gz"
          target: "/tmp/"
          debug: true
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_KEY_PHRASE }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          debug: true
          script: |
            set -e
            
            echo "ðŸš€ Starting deployment process..."
            
            # Navigate to deployment directory
            cd /www/wwwroot/whatcem.com
            
            # Backup current dist folder
            echo "ðŸ“¦ Backing up current dist folder..."
            if [ -d "dist" ]; then
              timestamp=$(date +%Y%m%d_%H%M%S)
              mv dist "~/dist_bckps/dist.backup.$timestamp" || true
            fi
            
            # Extract new dist folder
            echo "ðŸ“‚ Extracting new build..."
            tar -xzf /tmp/dist.tar.gz -C /www/wwwroot/whatcem.com/
            
            # Clean up temp file
            rm /tmp/dist.tar.gz
            
            # Fix permissions for manage.sh if needed
            echo "ðŸ”’ Ensuring manage.sh has execute permissions..."
            cd /www/wwwroot/whatcem.com/instances/whatcem
            chmod +x manage.sh
            
            # Backup docker logs
            echo "ðŸ“¦ Backing up docker logs..."
            docker logs docker logs powerchat-app-whatcem > ~/logs_bckps/powerchat-app-whatcem_logs_$timestamp.log || true

            # Stop the application
            echo "â¸ï¸  Stopping application..."
            cd /www/wwwroot/whatcem.com/instances/whatcem
            ./manage.sh stop
            
            # Wait a moment for clean shutdown
            sleep 3

            # Clean install of production dependencies
            echo "ðŸ“¦ Installing production dependencies..."
            cd /www/wwwroot/whatcem.com

            # Install dependencies with npm ci (clean install)
            npm ci --omit=dev --no-audit --no-fund

            # Wait a moment for clean install
            sleep 3
            
            # Start the application
            echo "â–¶ï¸  Starting application..."
            cd /www/wwwroot/whatcem.com/instances/whatcem
            ./manage.sh start
            
            # Wait for startup
            sleep 5
            
            echo "âœ… Deployment completed successfully!"
            
            # Show status
            echo "ðŸ“Š Application status:"
            cd /www/wwwroot/whatcem.com/instances/whatcem
            ./manage.sh status
        
      - name: Cleanup
        if: always()
        run: |
          rm -f dist.tar.gz
      
      - name: Deployment summary
        run: |
          echo "### Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
